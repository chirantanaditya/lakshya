---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header';
import Footer from '../../components/Footer';
import TestContainer from '../../components/TestContainer';
import { getSession } from '../../lib/session';
import { getUserById } from '../../lib/auth';
import { db } from '../../db';
import { behaviorResponseQuestions } from '../../db/schema';

const session = await getSession(Astro.cookies);

if (!session) {
  return Astro.redirect('/login');
}

const user = await getUserById(session.userId);

if (!user?.enableBehaviorResponse) {
  return Astro.redirect('/tests');
}

if (user.behaviorResponseStatus === 'Completed') {
  return Astro.redirect('/dashboard');
}

const questions = await db
  .select()
  .from(behaviorResponseQuestions)
  .orderBy(behaviorResponseQuestions.questionNumber);

const formattedQuestions = questions.map((q) => ({
  id: q.id,
  questionNumber: q.questionNumber || '',
  questionText: q.questionText || '',
  options: (q.options as string[]) || [],
}));
---

<BaseLayout title="Behaviour Response | Lakshya Counselling">
  <Header client:load session={session} />
  
  <main class="min-h-screen py-12 bg-gray-50">
    <div class="container mx-auto px-4">
      <TestContainer
        client:load
        testType="behaviour-response"
        testName="Behaviour Response"
        questions={formattedQuestions}
        onSubmit={async (responses) => {
          const response = await fetch('/api/tests/submit', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              testType: 'behaviour-response',
              responses,
            }),
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to submit test');
          }

          window.location.href = '/dashboard';
        }}
      />
    </div>
  </main>
  
  <Footer client:load />
</BaseLayout>

