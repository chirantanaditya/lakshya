---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header';
import Footer from '../../components/Footer';
import FiroBTest from '../../components/FiroBTest';
import { getSession } from '../../lib/session';
import { getUserById } from '../../lib/auth';
import { readFileSync } from 'fs';
import { join } from 'path';

const session = await getSession(Astro.cookies);

if (!session) {
  return Astro.redirect('/login');
}

const user = await getUserById(session.userId);

if (!user?.enableFiroB) {
  return Astro.redirect('/tests');
}

if (user.firoBStatus === 'Completed') {
  return Astro.redirect('/dashboard');
}

// Load questions from JSON file
let questions: Array<{ id: string; questionNumber: number; questionText: string; options: string[] }> = [];
try {
  const jsonPath = join(process.cwd(), 'data', 'firo-b-questions.json');
  const fileContent = readFileSync(jsonPath, 'utf-8');
  const questionsData = JSON.parse(fileContent);
  
  questions = questionsData.map((q: any) => ({
    id: q.id || `firob-q${q.questionNumber}`,
    questionNumber: q.questionNumber,
    questionText: q.questionText,
    options: q.options || [],
  }));
} catch (error: any) {
  console.error('Error loading Firo-B questions:', error);
  // Fallback: try loading from database if JSON fails
  const { db } = await import('../../db');
  const { firoBQuestions } = await import('../../db/schema');
  const dbQuestions = await db
    .select()
    .from(firoBQuestions)
    .orderBy(firoBQuestions.questionNumber);
  
  questions = dbQuestions.map((q, index) => ({
    id: q.id,
    questionNumber: parseInt(q.questionNumber || String(index + 1)) || index + 1,
    questionText: q.questionText || '',
    options: (q.options as string[]) || [],
  }));
}
---

<BaseLayout title="FIRO-B | Lakshya Counselling">
  <Header client:load session={session} />
  
  <main class="min-h-screen py-12 bg-gray-50">
    <div class="container mx-auto px-4">
      <FiroBTest
        client:load
        questions={questions}
        onSubmit={async (responses) => {
          const response = await fetch('/api/tests/submit', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              testType: 'firo-b',
              responses,
            }),
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to submit test');
          }

          window.location.href = '/dashboard';
        }}
      />
    </div>
  </main>
  
  <Footer client:load />
</BaseLayout>

