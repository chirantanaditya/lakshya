---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header';
import Footer from '../../components/Footer';
import GATBPart4Test from '../../components/GATBPart4Test';
import { getSession } from '../../lib/session';
import { getUserById } from '../../lib/auth';

const session = await getSession(Astro.cookies);

if (!session) {
  return Astro.redirect('/login');
}

const user = await getUserById(session.userId);

if (!user?.enableGeneralAptitude) {
  return Astro.redirect('/tests');
}

if (user.gatbPart4Status === 'Completed') {
  return Astro.redirect('/dashboard');
}

// Fetch questions from API
let formattedQuestions: any[] = [];
try {
  const baseUrl = Astro.url.origin;
  const response = await fetch(`${baseUrl}/api/tests/gatb-part-4-questions`);
  
  if (response.ok) {
    const data = await response.json();
    formattedQuestions = data.questions || [];
  } else {
    console.error('Failed to fetch questions:', response.statusText);
  }
} catch (error) {
  console.error('Error fetching questions:', error);
}
---

<BaseLayout title="GATB Part 4 | Lakshya Counselling">
  <Header client:load session={session} />
  
  <main class="min-h-screen py-12 bg-gray-50">
    <div class="container mx-auto px-4">
      <GATBPart4Test
        client:load
        questions={formattedQuestions}
      />
    </div>
  </main>
  
  <Footer client:load />

  <script define:vars={{ baseUrl: Astro.url.origin }}>
    window.gatbPart4SubmitHandler = async (responses) => {
      const response = await fetch(`${baseUrl}/api/tests/submit`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          testType: 'gatb-part-4',
          responses,
        }),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Failed to submit test');
      }

      const result = await response.json();
      
      // Console log for score display
      if (result.score) {
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.log('ğŸ“Š GATB Part 4 - Test Results');
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.log(`âœ… Correct Answers: ${result.score.correctAnswers}`);
        console.log(`âŒ Incorrect Answers: ${result.score.incorrectAnswers}`);
        console.log(`ğŸ“ˆ Total Questions: ${result.score.totalQuestions}`);
        console.log(`ğŸ¯ Score: ${result.score.score}/${result.score.totalQuestions}`);
        console.log(`ğŸ“Š Percentage: ${result.score.percentage}%`);
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      }

      window.location.href = '/tests/gatb-part-5-instructions';
    };
  </script>
</BaseLayout>

