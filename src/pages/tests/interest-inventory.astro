---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header';
import Footer from '../../components/Footer';
import InterestInventoryTest from '../../components/InterestInventoryTest';
import { getSession } from '../../lib/session';
import { getUserById } from '../../lib/auth';
import { readFileSync } from 'fs';
import { join } from 'path';

const session = await getSession(Astro.cookies);

if (!session) {
  return Astro.redirect('/login');
}

const user = await getUserById(session.userId);

if (!user?.enableInterestInventory) {
  return Astro.redirect('/tests');
}

if (user.interestInventoryStatus === 'Completed') {
  return Astro.redirect('/dashboard');
}

// Load questions from JSON file
let questions: Array<{ id: string; questionNumber: number; questionText: string; category: string }> = [];
try {
  const jsonPath = join(process.cwd(), 'data', 'interest-inventory-questions.json');
  const fileContent = readFileSync(jsonPath, 'utf-8');
  const questionsData = JSON.parse(fileContent);
  
  questions = questionsData.map((q: any) => ({
    id: q.id || `q${q.questionNumber}`,
    questionNumber: q.questionNumber,
    questionText: q.questionText,
    category: q.category || 'medical',
  }));
} catch (error: any) {
  console.error('Error loading interest inventory questions:', error);
  // Fallback: try loading from database if JSON fails
  const { db } = await import('../../db');
  const { interestInventoryQuestions } = await import('../../db/schema');
  const dbQuestions = await db
    .select()
    .from(interestInventoryQuestions)
    .orderBy(interestInventoryQuestions.questionNumber);
  
  // Generate categories based on question number pattern (cycles every 5)
  const categories = ['medical', 'technology', 'commerce', 'arts', 'fine-arts'];
  questions = dbQuestions.map((q, index) => ({
    id: q.id,
    questionNumber: parseInt(q.questionNumber || String(index + 1)) || index + 1,
    questionText: q.questionText || '',
    category: categories[index % 5] as 'medical' | 'technology' | 'commerce' | 'arts' | 'fine-arts',
  }));
}
---

<BaseLayout title="Interest Inventory | Lakshya Counselling">
  <Header client:load session={session} />
  
  <main class="min-h-screen bg-gray-50 pb-32">
    <div class="page-padding _100-width px-4 py-8">
      <div class="container-large container mx-auto max-w-7xl">
        <InterestInventoryTest
          client:load
          questions={questions}
          onSubmit={async (responses, scores) => {
            try {
              const response = await fetch('/api/tests/submit', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  testType: 'interest-inventory',
                  responses,
                  scores,
                }),
              });

              let data: any;
              try {
                data = await response.json();
              } catch (e) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
              }

              if (!response.ok) {
                throw new Error(data.error || 'Failed to submit test');
              }

              // Show success message briefly
              alert('Test submitted successfully!');
              window.location.href = '/dashboard';
            } catch (err: any) {
              console.error('Error submitting test:', err);
              throw err;
            }
          }}
        />
      </div>
    </div>
  </main>
  
  <Footer client:load />
</BaseLayout>
